<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falcon-512 WebAssembly Browser Example</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .output {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .info {
            color: #2c3e50;
        }
        .loading {
            color: #f39c12;
            font-style: italic;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
            margin: 10px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 12px;
            text-transform: uppercase;
        }
        .stat-value {
            color: #2c3e50;
            font-size: 24px;
            font-weight: bold;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Falcon-512 WebAssembly Demo</h1>
        <p>Post-quantum digital signatures running in your browser!</p>

        <div id="status" class="output loading">Loading WebAssembly module...</div>

        <h2>1. Generate Keypair</h2>
        <button id="generateBtn" disabled>Generate Random Keypair</button>
        <div id="keyOutput" class="output" style="display:none;"></div>

        <h2>2. Sign a Message</h2>
        <input type="text" id="messageInput" placeholder="Enter message to sign..." value="Hello, Falcon-512!">
        <button id="signBtn" disabled>Sign Message</button>
        <div id="signOutput" class="output" style="display:none;"></div>

        <h2>3. Verify Signature</h2>
        <button id="verifyBtn" disabled>Verify Signature</button>
        <button id="verifyTamperedBtn" disabled>Verify Tampered Message</button>
        <div id="verifyOutput" class="output" style="display:none;"></div>

        <h2>4. Extract Coefficients</h2>
        <button id="extractBtn" disabled>Extract All Coefficients</button>
        <div id="extractOutput" class="output" style="display:none;"></div>

        <h2>Statistics</h2>
        <div class="stats">
            <div class="stat-box">
                <div class="stat-label">Private Key</div>
                <div class="stat-value" id="privkeySize">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Public Key</div>
                <div class="stat-value" id="pubkeySize">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Signature</div>
                <div class="stat-value" id="sigSize">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Polynomial Degree</div>
                <div class="stat-value">512</div>
            </div>
        </div>
    </div>

    <!-- Load as ES6 module -->
    <script type="module">
        // Import the Falcon module
        // Note: Adjust path based on your build output location
        import { Falcon512 } from '../dist/falcon.js';
        import createFalconModule from '../dist/falcon.js';

        let falcon;
        let keypair = null;
        let signature = null;
        let currentMessage = null;

        // Initialize
        async function init() {
            try {
                document.getElementById('status').textContent = 'Initializing Falcon-512...';
                
                falcon = new Falcon512();
                await falcon.init(createFalconModule);
                
                document.getElementById('status').innerHTML = '<span class="success">‚úì Falcon-512 ready!</span>';
                document.getElementById('generateBtn').disabled = false;
                
            } catch (error) {
                document.getElementById('status').innerHTML = 
                    `<span class="error">‚úó Initialization failed: ${error.message}</span>`;
                console.error(error);
            }
        }

        // Generate keypair
        document.getElementById('generateBtn').addEventListener('click', () => {
            try {
                const seed = new Uint8Array(48);
                crypto.getRandomValues(seed);
                
                const startTime = performance.now();
                keypair = falcon.createKeypairFromSeed(seed);
                const duration = (performance.now() - startTime).toFixed(2);
                
                document.getElementById('keyOutput').style.display = 'block';
                document.getElementById('keyOutput').innerHTML = 
                    `<span class="success">‚úì Keypair generated in ${duration}ms</span>\n\n` +
                    `Private Key (${keypair.privateKey.length} bytes):\n${toHex(keypair.privateKey, 32)}\n\n` +
                    `Public Key (${keypair.publicKey.length} bytes):\n${toHex(keypair.publicKey, 32)}`;
                
                document.getElementById('privkeySize').textContent = `${keypair.privateKey.length}B`;
                document.getElementById('pubkeySize').textContent = `${keypair.publicKey.length}B`;
                
                document.getElementById('signBtn').disabled = false;
                
            } catch (error) {
                showError('keyOutput', error);
            }
        });

        // Sign message
        document.getElementById('signBtn').addEventListener('click', () => {
            if (!keypair) {
                alert('Please generate a keypair first!');
                return;
            }
            
            try {
                const message = document.getElementById('messageInput').value;
                currentMessage = new TextEncoder().encode(message);
                
                const rngSeed = new Uint8Array(48);
                crypto.getRandomValues(rngSeed);
                
                const startTime = performance.now();
                signature = falcon.signMessage(currentMessage, keypair.privateKey, rngSeed);
                const duration = (performance.now() - startTime).toFixed(2);
                
                document.getElementById('signOutput').style.display = 'block';
                document.getElementById('signOutput').innerHTML = 
                    `<span class="success">‚úì Message signed in ${duration}ms</span>\n\n` +
                    `Message: "${message}"\n\n` +
                    `Signature (${signature.length} bytes):\n${toHex(signature, 64)}`;
                
                document.getElementById('sigSize').textContent = `${signature.length}B`;
                
                document.getElementById('verifyBtn').disabled = false;
                document.getElementById('verifyTamperedBtn').disabled = false;
                document.getElementById('extractBtn').disabled = false;
                
            } catch (error) {
                showError('signOutput', error);
            }
        });

        // Verify signature
        document.getElementById('verifyBtn').addEventListener('click', () => {
            if (!keypair || !signature || !currentMessage) {
                alert('Please sign a message first!');
                return;
            }
            
            try {
                const startTime = performance.now();
                const isValid = falcon.verifySignature(currentMessage, signature, keypair.publicKey);
                const duration = (performance.now() - startTime).toFixed(2);
                
                document.getElementById('verifyOutput').style.display = 'block';
                document.getElementById('verifyOutput').innerHTML = 
                    isValid 
                        ? `<span class="success">‚úì Signature is VALID (verified in ${duration}ms)</span>`
                        : `<span class="error">‚úó Signature is INVALID</span>`;
                
            } catch (error) {
                showError('verifyOutput', error);
            }
        });

        // Verify tampered message
        document.getElementById('verifyTamperedBtn').addEventListener('click', () => {
            if (!keypair || !signature) {
                alert('Please sign a message first!');
                return;
            }
            
            try {
                const tamperedMessage = new TextEncoder().encode('TAMPERED MESSAGE');
                
                const startTime = performance.now();
                const isValid = falcon.verifySignature(tamperedMessage, signature, keypair.publicKey);
                const duration = (performance.now() - startTime).toFixed(2);
                
                document.getElementById('verifyOutput').style.display = 'block';
                document.getElementById('verifyOutput').innerHTML = 
                    isValid 
                        ? `<span class="error">‚úó Tampered signature verified (this should not happen!)</span>`
                        : `<span class="success">‚úì Tampered signature correctly REJECTED (in ${duration}ms)</span>`;
                
            } catch (error) {
                showError('verifyOutput', error);
            }
        });

        // Extract coefficients
        document.getElementById('extractBtn').addEventListener('click', () => {
            if (!keypair || !signature || !currentMessage) {
                alert('Please sign a message first!');
                return;
            }
            
            try {
                const hashPoint = falcon.hashToPoint(currentMessage);
                const pubkeyCoeffs = falcon.getPublicKeyCoefficients(keypair.publicKey);
                const sigCoeffs = falcon.getSignatureCoefficients(signature);
                
                document.getElementById('extractOutput').style.display = 'block';
                document.getElementById('extractOutput').innerHTML = 
                    `<span class="success">‚úì All coefficients extracted</span>\n\n` +
                    `Hash-to-Point (512 coefficients):\n[${hashPoint.slice(0, 10).join(', ')}...]\n\n` +
                    `Public Key Coefficients (512 coefficients):\n[${pubkeyCoeffs.slice(0, 10).join(', ')}...]\n\n` +
                    `Signature s1 (512 coefficients):\n[${sigCoeffs.s1.slice(0, 10).join(', ')}...]\n\n` +
                    `Signature s2 (512 coefficients):\n[${sigCoeffs.s2.slice(0, 10).join(', ')}...]`;
                
            } catch (error) {
                showError('extractOutput', error);
            }
        });

        // Helper functions
        function toHex(bytes, maxLength = bytes.length) {
            const limited = bytes.slice(0, maxLength);
            const hex = Array.from(limited)
                .map(b => b.toString(16).padStart(2, '0'))
                .join(' ');
            return maxLength < bytes.length ? hex + '...' : hex;
        }

        function showError(elementId, error) {
            document.getElementById(elementId).style.display = 'block';
            document.getElementById(elementId).innerHTML = 
                `<span class="error">‚úó Error: ${error.message}</span>`;
            console.error(error);
        }

        // Start initialization
        init();
    </script>
</body>
</html>
