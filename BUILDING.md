# Building Falcon-512 WASM

Detailed instructions for building the Falcon-512 WebAssembly module from source.

## Prerequisites

### Required Tools

1. **Emscripten SDK** (version 3.1.0 or later)
   - Download from: https://emscripten.org/docs/getting_started/downloads.html
   - Installation guide: https://emscripten.org/docs/getting_started/

2. **Node.js** (version 16 or later)
   - Download from: https://nodejs.org/

3. **TypeScript** (installed via npm)
   ```bash
   npm install -g typescript
   ```

4. **Git** (for cloning the repository)

### Platform-Specific Requirements

#### Linux/macOS
- Bash shell
- Standard build tools (make, gcc)

#### Windows
- Git Bash or WSL (for bash scripts), OR
- Use the provided `.bat` script for native Windows

## Step-by-Step Build Instructions

### 1. Install Emscripten

#### Option A: Using emsdk (Recommended)

```bash
# Clone the emsdk repository
git clone https://github.com/emscripten-core/emsdk.git
cd emsdk

# Download and install the latest SDK
./emsdk install latest

# Activate the SDK
./emsdk activate latest

# Set up environment variables (add to your shell profile)
source ./emsdk_env.sh
```

For Windows:
```cmd
emsdk install latest
emsdk activate latest
emsdk_env.bat
```

#### Option B: Using Package Manager

**Ubuntu/Debian:**
```bash
sudo apt-get install emscripten
```

**macOS (Homebrew):**
```bash
brew install emscripten
```

### 2. Clone and Setup Project

```bash
# Clone the repository
git clone <repository-url>
cd falcon-qone-wasm

# Install Node.js dependencies
npm install
```

### 3. Build WebAssembly Module

#### Linux/macOS:
```bash
# Make the build script executable
chmod +x build.sh

# Run the build
./build.sh
```

Or using npm:
```bash
npm run build:wasm
```

#### Windows:
```cmd
build.bat
```

Or using npm:
```cmd
npm run build:wasm:win
```

### 4. Build TypeScript

```bash
# Compile TypeScript to JavaScript
npm run build:ts
```

### 5. Build Everything

```bash
# Build both WASM and TypeScript
npm run build
```

## Build Output

After a successful build, you should see:

```
dist/
├── falcon.js         # JavaScript loader (generated by Emscripten)
├── falcon.wasm       # WebAssembly binary
├── falcon.d.ts       # TypeScript type definitions
└── falcon.js.map     # Source map (if enabled)
```

## Verifying the Build

### 1. Check Output Files

```bash
ls -lh dist/
```

Expected sizes:
- `falcon.wasm`: ~200-300 KB
- `falcon.js`: ~50-100 KB
- `falcon.d.ts`: ~5 KB

### 2. Run Tests

```bash
npm test
```

All tests should pass:
```
✓ Falcon512 › Constants › should have correct constant values
✓ Falcon512 › Keypair Generation › should generate a keypair from a seed
✓ Falcon512 › Sign and Verify › should sign a message
...
```

### 3. Try the Example

```bash
node examples/basic-usage.js
```

## Troubleshooting

### Problem: `emcc: command not found`

**Solution**: Emscripten is not in your PATH. Run:
```bash
source /path/to/emsdk/emsdk_env.sh
```

Or add this to your `.bashrc` / `.zshrc`:
```bash
export PATH="/path/to/emsdk:$PATH"
export PATH="/path/to/emsdk/upstream/emscripten:$PATH"
```

### Problem: `Cannot find module 'emscripten'`

**Solution**: Install Emscripten type definitions:
```bash
npm install --save-dev @types/emscripten
```

### Problem: Build succeeds but WASM fails to load

**Solution**: 
1. Check that `falcon.wasm` and `falcon.js` are in the same directory
2. Verify you're using a web server (not `file://` protocol) for browser tests
3. Check browser console for detailed error messages

### Problem: Tests fail with "Module not initialized"

**Solution**: Make sure to call `await falcon.init()` before using the API:
```typescript
const falcon = new Falcon512();
await falcon.init(createFalconModule);
// Now you can use falcon methods
```

### Problem: Memory errors during build

**Solution**: Increase WASM memory in `build.sh`:
```bash
-s TOTAL_MEMORY=33554432  # 32MB instead of 16MB
```

### Problem: Windows build fails with line ending errors

**Solution**: Configure Git to handle line endings:
```bash
git config --global core.autocrlf false
```

## Build Customization

### Optimization Levels

Edit `build.sh` or `build.bat`:

```bash
# For debugging (larger, slower, easier to debug)
CFLAGS="-O0 -g"

# For production (smaller, faster, harder to debug)
CFLAGS="-O3 -flto"
```

### Memory Configuration

```bash
# Increase initial memory
-s TOTAL_MEMORY=33554432  # 32MB

# Increase maximum memory growth
-s MAXIMUM_MEMORY=67108864  # 64MB max
```

### Export Additional Functions

In `build.sh`, modify exported functions:
```bash
-s EXPORTED_FUNCTIONS='["_malloc","_free","_falcon512_keygen_from_seed",...]'
```

### Enable Debug Output

```bash
# Add to EMFLAGS in build.sh
-s ASSERTIONS=1
-s SAFE_HEAP=1
-g
```

## Advanced Build Options

### Profile-Guided Optimization

1. Build with profiling:
   ```bash
   emcc -fprofile-generate ...
   ```

2. Run representative workload

3. Rebuild with profile data:
   ```bash
   emcc -fprofile-use ...
   ```

### WebAssembly SIMD

```bash
# Enable SIMD (experimental)
-msimd128
```

### Link-Time Optimization

```bash
# Already enabled with -flto
# For more aggressive optimization:
-flto=full
```

## CI/CD Integration

### GitHub Actions Example

```yaml
name: Build and Test

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '18'
    
    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v11
      with:
        version: 'latest'
    
    - name: Install dependencies
      run: npm install
    
    - name: Build WASM
      run: npm run build:wasm
    
    - name: Build TypeScript
      run: npm run build:ts
    
    - name: Run tests
      run: npm test
```

## Performance Tuning

### Measure Build Time

```bash
time ./build.sh
```

### Measure WASM Size

```bash
ls -lh dist/falcon.wasm
wasm-opt --version  # If you have binaryen installed
```

### Optimize WASM Post-Build

```bash
# Install binaryen tools
npm install -g binaryen

# Optimize
wasm-opt -O3 dist/falcon.wasm -o dist/falcon.opt.wasm
```

## Cross-Compilation

### For Different Targets

```bash
# Web (default)
-s ENVIRONMENT='web'

# Node.js only
-s ENVIRONMENT='node'

# Both
-s ENVIRONMENT='web,node'

# Worker
-s ENVIRONMENT='worker'
```

## Next Steps

After building successfully:

1. ✅ Run the test suite: `npm test`
2. ✅ Try the examples: `node examples/basic-usage.js`
3. ✅ Review the API documentation in `README.md`
4. ✅ Read implementation details in `IMPLEMENTATION.md`

## Getting Help

- Check the [Issues](https://github.com/your-repo/issues) page
- Review [Emscripten Documentation](https://emscripten.org/docs/)
- See [WebAssembly Documentation](https://webassembly.org/)

## References

- [Emscripten Tutorial](https://emscripten.org/docs/getting_started/Tutorial.html)
- [WebAssembly Compilation](https://webassembly.org/getting-started/developers-guide/)
- [Falcon Specification](https://falcon-sign.info/)
